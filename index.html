<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FR SYSTEM — Misure</title>
  <style>
    :root{
      --bg:#F5F5F7;
      --surface:#FFFFFF;
      --text:#1D3557;
      --muted:rgba(29,53,87,.72);
      --border:rgba(29,53,87,.14);
      --shadow:0 10px 28px rgba(29,53,87,.08);
      --primary:#1D3557;
      --ok:#26A69A;
      --warn:#FB8C00;
      --bad:#E53935;
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px;min-height:100%;display:flex;flex-direction:column;gap:12px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:14px;background:var(--surface);border:1px solid var(--border);
      border-radius:var(--r);box-shadow:var(--shadow);
      position:relative; z-index:1000;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:120px;max-width:38vw;height:auto;display:block}
    .brandTitle{font-weight:1000;letter-spacing:.2px;font-size:16px;line-height:1.1}
    .brandSub{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.35}

    .pill{
      font-size:12px;padding:7px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;color:var(--muted);font-weight:900;white-space:nowrap;
    }
    .pill.ok{border-color:rgba(38,166,154,.35);background:rgba(38,166,154,.14);color:var(--ok)}
    .pill.warn{border-color:rgba(251,140,0,.35);background:rgba(251,140,0,.14);color:var(--warn)}
    .pill.bad{border-color:rgba(229,57,53,.35);background:rgba(229,57,53,.12);color:var(--bad)}

    .card{
      width:100%;background:var(--surface);border:1px solid var(--border);
      border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;
      position:relative; z-index:10;
    }
    .center{flex:1;display:flex;align-items:center;justify-content:center}
    .hero{max-width:820px}
    .heroHead{padding:18px 18px 12px}
    .heroTitle{font-weight:1000;font-size:22px;letter-spacing:.2px}
    .heroDesc{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4}
    .divider{height:1px;background:var(--border)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:16px 18px 8px}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}}
    .btn{
      display:block;text-decoration:none;color:inherit;border:1px solid var(--border);
      border-radius:var(--r2);background:#fff;padding:14px 14px;
      transition:transform .04s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:rgba(29,53,87,.03)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:#16304d}
    .btn.big{padding:16px}
    .btnTitle{font-weight:1000;letter-spacing:.2px;font-size:16px}
    .btnDesc{margin-top:6px;font-size:12px;color:rgba(245,245,247,.88)}
    .btn:not(.primary) .btnDesc{color:var(--muted)}

    .note{
      margin:8px 18px 18px;font-size:12px;color:var(--muted);font-weight:900;
      padding:10px 12px;border-radius:var(--r2);border:1px solid var(--border);background:#fff;
    }
    .note.ok{border-color:rgba(38,166,154,.35);background:rgba(38,166,154,.12);color:var(--ok)}
    .note.warn{border-color:rgba(251,140,0,.35);background:rgba(251,140,0,.12);color:rgba(29,53,87,.9)}
    .note.bad{border-color:rgba(229,57,53,.35);background:rgba(229,57,53,.12);color:rgba(29,53,87,.95)}

    .panel{padding:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:relative;z-index:1000}
    .kbtn{
      appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);
      padding:10px 12px;border-radius:var(--r2);font-weight:1000;cursor:pointer;
      transition:transform .04s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .kbtn:active{transform:translateY(1px)}
    .kbtn:hover{background:rgba(29,53,87,.04)}
    .kbtn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .kbtn.primary:hover{background:#16304d}
    .kbtn.danger{color:var(--bad);border-color:rgba(229,57,53,.35)}
    .kbtn.danger:hover{background:rgba(229,57,53,.10)}
    .kbtn:disabled{opacity:.45;cursor:not-allowed}

    .viewer{
      position:relative;width:100%;background:#0b0f14;overflow:hidden;
      border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      height:min(60vh,560px);min-height:360px;
    }
    @media (min-width:860px){.viewer{height:520px}}
    .overlay2d{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .hidden{display:none !important}

    video.cam, canvas.cam{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      background:#0b0f14;
      display:block;
    }

    .hud{padding:12px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;position:relative;z-index:1000}
    .hudBox{flex:1 1 260px;border:1px solid var(--border);background:#fff;border-radius:var(--r2);padding:10px 12px;}
    .hudLabel{font-size:12px;color:var(--muted);font-weight:1000;letter-spacing:.15px}
    .hudValue{margin-top:4px;font-size:18px;font-weight:1000}
    .hudSub{margin-top:4px;font-size:12px;color:var(--muted);font-weight:900;line-height:1.35}
    .list{margin:0;padding-left:18px;font-weight:900}
    .small{font-size:12px;font-weight:900;color:var(--muted)}
    .foot{text-align:center;padding:6px 0 2px}
  </style>
</head>

<body>
<div class="wrap" id="appRoot">
  <header class="topbar">
    <div class="brand">
      <img class="logo" src="logo.png" alt="FR Color" onerror="this.style.display='none'">
      <div>
        <div class="brandTitle">FR SYSTEM</div>
        <div class="brandSub" id="subTitle">Seleziona la modalità di misurazione</div>
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span class="pill" id="httpsPill">HTTPS: —</span>
      <span class="pill" id="camPill">CAM: —</span>
      <span class="pill" id="arPillTop">AR: —</span>
      <button class="kbtn hidden" id="btnHome">Home</button>
    </div>
  </header>

  <!-- HOME -->
  <main class="center" id="homeView">
    <section class="card hero">
      <div class="heroHead">
        <div class="heroTitle">Misure</div>
        <div class="heroDesc">
          Telemetro: indicativo con camera + sensori (calibrabile). AR: misura reale A→B (solo dispositivi compatibili).
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <button class="btn big" id="goTele">
          <div class="btnTitle">Telemetro</div>
          <div class="btnDesc">Camera + sensori • Indicativo • Calibrazione 1 volta</div>
        </button>

        <button class="btn big primary" id="goAR">
          <div class="btnTitle">AR Misure</div>
          <div class="btnDesc">WebXR AR • Tap A/B • Salva 10</div>
        </button>
      </div>

      <div class="note" id="compatNote">Controllo compatibilità…</div>
    </section>
  </main>

  <!-- TELEMETRO -->
  <section class="card hidden" id="teleView">
    <div class="panel">
      <button class="kbtn primary" id="tStartCam">Avvia Fotocamera</button>
      <button class="kbtn" id="tEnableSensors">Attiva sensori</button>
      <button class="kbtn" id="tBase" disabled>Tap Base</button>
      <button class="kbtn" id="tTop" disabled>Tap Alto</button>
      <button class="kbtn" id="tReset" disabled>Reset</button>
      <button class="kbtn" id="tSave" disabled>Salva</button>
      <button class="kbtn danger" id="tClearHistory">Azzera storico</button>
      <span class="pill warn" id="tPill">Stato: —</span>
    </div>

    <div class="panel" style="padding-top:0;">
      <div class="small">Altezza telefono da terra (cm)</div>
      <input class="kbtn" id="tHeight" type="number" min="50" max="250" step="1" value="150" style="width:220px;" />
      <div class="small">Fattore telemetro (calibrazione)</div>
      <input class="kbtn" id="tFactor" type="number" min="0.50" max="3.00" step="0.01" value="1.00" style="width:220px;" />
      <button class="kbtn" id="tCalib" disabled>Calibra su distanza nota</button>
      <button class="kbtn danger" id="tResetCalib">Reset calibrazione</button>
    </div>

    <div class="viewer" id="tViewer">
      <video class="cam" id="tVideo" playsinline muted autoplay></video>
      <canvas class="overlay2d" id="tHud"></canvas>
    </div>

    <div class="hud">
      <div class="hudBox">
        <div class="hudLabel">Risultato</div>
        <div class="hudValue" id="tOutMain">—</div>
        <div class="hudSub" id="tOutSub">
          1) Avvia Fotocamera  2) Attiva sensori  3) Punta BASE → Tap Base  4) Punta ALTO → Tap Alto
        </div>
      </div>

      <div class="hudBox">
        <div class="hudLabel" id="tHistLabel">Storico misure (0/10)</div>
        <ol class="list" id="tHistList"></ol>
      </div>
    </div>

    <div class="panel">
      <div class="note warn" style="margin:0; width:100%;">
        Telemetro = trigonometria. Se misura doppio/dimezza: premi “Calibra” usando una distanza reale nota.
      </div>
    </div>
  </section>

  <!-- AR -->
  <section class="card hidden" id="arView">
    <div class="panel">
      <button class="kbtn primary" id="arStartCam">Avvia Fotocamera</button>
      <button class="kbtn primary" id="arStartXR">Avvia AR</button>
      <button class="kbtn" id="arStopXR" disabled>Esci AR</button>
      <button class="kbtn" id="arReset" disabled>Reset</button>
      <button class="kbtn" id="arSave" disabled>Salva</button>
      <button class="kbtn danger" id="arClearHistory">Azzera storico</button>

      <span class="pill" id="arPill">AR: —</span>
      <span class="pill" id="arModePill">Modalità: Distanza</span>

      <select class="kbtn" id="arModeSel" style="padding:10px 12px;">
        <option value="distance" selected>Distanza (2 tap)</option>
        <option value="area">Area (4 tap)</option>
      </select>
    </div>

    <div class="viewer" id="arViewer">
      <video class="cam" id="arVideo" playsinline muted autoplay></video>
      <canvas id="arGL" class="cam" style="display:none;"></canvas>
      <canvas class="overlay2d" id="arHud"></canvas>
    </div>

    <div class="hud">
      <div class="hudBox">
        <div class="hudLabel">Risultato</div>
        <div class="hudValue" id="arOutMain">—</div>
        <div class="hudSub" id="arOutSub">
          1) Avvia camera  2) Avvia AR  3) Tap A  4) Muovi (live)  5) Tap B  6) Salva
        </div>
      </div>

      <div class="hudBox">
        <div class="hudLabel" id="arHistLabel">Storico misure (0/10)</div>
        <ol class="list" id="arHistList"></ol>
      </div>
    </div>

    <div class="panel">
      <div class="note warn" style="margin:0; width:100%;">
        Per aggancio AR: luce buona + pavimento/superficie con texture. Evita pareti bianche lisce.
      </div>
    </div>
  </section>

  <footer class="foot">
    <span class="small">FR Color • Stile e colori ufficiali</span>
  </footer>
</div>

<script>
/* ========= ROUTER ========= */
const homeView = document.getElementById('homeView');
const arView   = document.getElementById('arView');
const teleView = document.getElementById('teleView');
const btnHome  = document.getElementById('btnHome');
const subTitle = document.getElementById('subTitle');

function show(view){
  homeView.classList.add('hidden');
  arView.classList.add('hidden');
  teleView.classList.add('hidden');
  btnHome.classList.remove('hidden');

  if(view==='home'){
    homeView.classList.remove('hidden');
    btnHome.classList.add('hidden');
    subTitle.textContent = 'Seleziona la modalità di misurazione';
  }
  if(view==='tele'){
    teleView.classList.remove('hidden');
    subTitle.textContent = 'Telemetro • Camera + sensori • Calibrazione';
  }
  if(view==='ar'){
    arView.classList.remove('hidden');
    subTitle.textContent = 'AR Misure • WebXR • Tap A/B';
  }
}
btnHome.addEventListener('click', () => show('home'));
document.getElementById('goTele').addEventListener('click', () => show('tele'));
document.getElementById('goAR').addEventListener('click', () => show('ar'));

/* ========= STATUS ========= */
const httpsPill = document.getElementById('httpsPill');
const camPill   = document.getElementById('camPill');
const arPillTop = document.getElementById('arPillTop');
const compatNote= document.getElementById('compatNote');

function setPill(el, text, kind){
  el.textContent = text;
  el.classList.remove('ok','warn','bad');
  if(kind) el.classList.add(kind);
}
const httpsOk = (location.protocol === 'https:' || location.hostname === 'localhost') && window.isSecureContext;
setPill(httpsPill, httpsOk ? 'HTTPS: OK' : 'HTTPS: NO', httpsOk ? 'ok' : 'bad');

/* ========= CAMERA (shared) ========= */
let camStream = null;

async function startCamera(videoEl){
  if(!httpsOk) throw new Error('HTTPS richiesto');
  if(!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia non supportato');

  if(camStream){
    videoEl.srcObject = camStream;
    await videoEl.play().catch(()=>{});
    setPill(camPill,'CAM: OK','ok');
    return;
  }
  camStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } },
    audio: false
  });
  videoEl.srcObject = camStream;
  await videoEl.play().catch(()=>{});
  setPill(camPill,'CAM: OK','ok');
}

function stopCamera(){
  if(!camStream) return;
  camStream.getTracks().forEach(t => t.stop());
  camStream = null;
  setPill(camPill,'CAM: OFF','warn');
}

/* ========= WEBXR SUPPORT CHECK ========= */
async function checkWebXRAR(){
  if(!httpsOk) return false;
  if(!('xr' in navigator)) return false;
  try{
    return await navigator.xr.isSessionSupported('immersive-ar');
  }catch{
    return false;
  }
}

(async () => {
  setPill(camPill,'CAM: —','warn');
  const arOk = await checkWebXRAR();
  setPill(arPillTop, arOk ? 'AR: possibile' : 'AR: no', arOk ? 'ok' : 'warn');
  compatNote.textContent = arOk
    ? 'WebXR AR disponibile: puoi usare AR Misure.'
    : 'WebXR AR non disponibile qui: usa Telemetro.';
  compatNote.className = 'note ' + (arOk ? 'ok' : 'warn');
})();

/* ========= TELEMETRO ========= */
(() => {
  const tVideo = document.getElementById('tVideo');
  const tHud   = document.getElementById('tHud');
  const btnCam = document.getElementById('tStartCam');
  const btnSen = document.getElementById('tEnableSensors');
  const btnBase= document.getElementById('tBase');
  const btnTop = document.getElementById('tTop');
  const btnReset=document.getElementById('tReset');
  const btnSave=document.getElementById('tSave');
  const btnClear=document.getElementById('tClearHistory');
  const pill   = document.getElementById('tPill');

  const inH    = document.getElementById('tHeight');
  const inF    = document.getElementById('tFactor');
  const btnCalib = document.getElementById('tCalib');
  const btnResetCalib = document.getElementById('tResetCalib');

  const outMain= document.getElementById('tOutMain');
  const outSub = document.getElementById('tOutSub');
  const histLbl= document.getElementById('tHistLabel');
  const histList=document.getElementById('tHistList');

  const LS_H = 'fr_tele_height_cm';
  const LS_F = 'fr_tele_factor';

  const savedH = parseFloat(localStorage.getItem(LS_H));
  const savedF = parseFloat(localStorage.getItem(LS_F));
  if(Number.isFinite(savedH)) inH.value = String(savedH);
  if(Number.isFinite(savedF)) inF.value = String(savedF);

  const T = { pitchDeg:null, basePitch:null, topPitch:null, lastRaw:null, lastCorr:null, history:[] };

  function set(text,kind){
    pill.textContent = text;
    pill.classList.remove('ok','warn','bad');
    if(kind) pill.classList.add(kind);
  }
  function rad(d){ return d*Math.PI/180; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function fmt(m){
    if(!Number.isFinite(m)) return '—';
    if(m>=10) return `${m.toFixed(2)} m`;
    if(m>=1) return `${m.toFixed(3)} m`;
    return `${(m*100).toFixed(1)} cm`;
  }
  function updateHistory(){
    histList.innerHTML='';
    T.history.forEach(x=>{const li=document.createElement('li'); li.textContent=x; histList.appendChild(li);});
    histLbl.textContent = `Storico misure (${T.history.length}/10)`;
  }
  function addHistory(x){
    if(T.history.length===10) T.history=[];
    T.history.push(x);
    updateHistory();
  }

  function drawCrosshair(){
    const dpr = window.devicePixelRatio || 1;
    const rect = tVideo.getBoundingClientRect();
    tHud.width  = Math.max(1, Math.round(rect.width * dpr));
    tHud.height = Math.max(1, Math.round(rect.height * dpr));
    const ctx = tHud.getContext('2d');
    ctx.clearRect(0,0,tHud.width,tHud.height);
    const cx = tHud.width/2, cy = tHud.height/2;
    ctx.strokeStyle='rgba(245,245,247,.92)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(cx-18,cy); ctx.lineTo(cx+18,cy);
    ctx.moveTo(cx,cy-18); ctx.lineTo(cx,cy+18);
    ctx.stroke();
  }
  window.addEventListener('resize', drawCrosshair);

  function handleOri(e){
    if(typeof e.beta !== 'number') return;
    T.pitchDeg = -e.beta;
  }

  async function enableSensors(){
    try{
      if(typeof DeviceOrientationEvent !== 'undefined' &&
         typeof DeviceOrientationEvent.requestPermission === 'function'){
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== 'granted') throw new Error('Permission denied');
      }
      window.addEventListener('deviceorientation', handleOri, true);
      set('Sensori: OK','ok');
      btnBase.disabled=false;
      btnTop.disabled=false;
      btnReset.disabled=false;
      btnCalib.disabled=false;
      outSub.textContent='Sensori attivi. Punta BASE → Tap Base. Poi punta ALTO → Tap Alto.';
    }catch{
      set('Sensori: KO','bad');
      outSub.textContent='Non riesco ad attivare i sensori.';
    }
  }

  function compute(){
    const hCm = parseFloat(inH.value);
    const h = (Number.isFinite(hCm) && hCm>0) ? (hCm/100) : 1.5;
    localStorage.setItem(LS_H, String(hCm));

    const factor = clamp(parseFloat(inF.value) || 1.0, 0.5, 3.0);
    localStorage.setItem(LS_F, String(factor));

    if(T.basePitch==null || T.topPitch==null) return;

    const tanA = Math.tan(Math.abs(rad(T.basePitch)));
    if(!Number.isFinite(tanA) || tanA < 1e-4){
      outMain.textContent='Errore';
      outSub.textContent='Angolo BASE troppo orizzontale.';
      return;
    }

    const D_raw = h / tanA;
    const H_raw = h + D_raw * Math.tan(rad(T.topPitch));

    const D = D_raw / factor;
    const H = H_raw / factor;

    T.lastRaw = {D:D_raw, H:H_raw};
    T.lastCorr= {D, H};

    outMain.textContent = `Distanza: ${fmt(D)} • Altezza: ${fmt(H)}`;
    outSub.textContent =
      `Base: ${T.basePitch.toFixed(1)}° • Alto: ${T.topPitch.toFixed(1)}° • h: ${(h*100).toFixed(0)} cm • fattore: ${factor.toFixed(2)}`;

    btnSave.disabled=false;
  }

  function reset(){
    T.basePitch=null; T.topPitch=null; T.lastRaw=null; T.lastCorr=null;
    btnSave.disabled=true;
    outMain.textContent='—';
    outSub.textContent='Punta BASE → Tap Base. Poi punta ALTO → Tap Alto.';
  }

  btnCam.addEventListener('click', async () => {
    try{
      await startCamera(tVideo);
      set('Camera: OK','ok');
      drawCrosshair();
    }catch(err){
      set('Camera: KO','bad');
      outSub.textContent = `Camera non disponibile: ${err.message}`;
    }
  });

  btnSen.addEventListener('click', enableSensors);

  btnBase.addEventListener('click', () => {
    if(T.pitchDeg==null){ outSub.textContent='Prima “Attiva sensori”.'; return; }
    T.basePitch = T.pitchDeg;
    outSub.textContent = `BASE salvata (${T.basePitch.toFixed(1)}°). Ora punta ALTO → Tap Alto.`;
    compute();
  });

  btnTop.addEventListener('click', () => {
    if(T.pitchDeg==null){ outSub.textContent='Prima “Attiva sensori”.'; return; }
    T.topPitch = T.pitchDeg;
    outSub.textContent = `ALTO salvato (${T.topPitch.toFixed(1)}°).`;
    compute();
  });

  btnReset.addEventListener('click', reset);

  btnSave.addEventListener('click', () => {
    if(!T.lastCorr) return;
    addHistory(`Telemetro — D: ${fmt(T.lastCorr.D)} • H: ${fmt(T.lastCorr.H)}`);
    btnSave.disabled=true;
    outSub.textContent='Salvato ✅';
  });

  btnClear.addEventListener('click', () => { T.history=[]; updateHistory(); });

  btnCalib.addEventListener('click', () => {
    if(!T.lastCorr?.D || !T.lastRaw?.D) return;
    const s = prompt('Distanza reale in METRI (es: 2):', '2');
    const real = parseFloat(s || '');
    if(!Number.isFinite(real) || real <= 0) return;

    const newFactor = clamp(T.lastRaw.D / real, 0.5, 3.0);
    inF.value = newFactor.toFixed(2);
    localStorage.setItem(LS_F, String(newFactor));
    compute();
    outSub.textContent = `Calibrato ✅ fattore: ${newFactor.toFixed(2)} (ora riprova)`;
  });

  btnResetCalib.addEventListener('click', () => {
    inF.value = '1.00';
    localStorage.setItem(LS_F, '1.00');
    compute();
    outSub.textContent = 'Calibrazione resettata (fattore 1.00)';
  });

  inH.addEventListener('change', compute);
  inF.addEventListener('change', compute);

  set('Stato: pronto','warn');
  updateHistory();
  drawCrosshair();
})();

/* ========= AR WEBXR (dom-overlay + tap overlay) ========= */
(() => {
  const arVideo = document.getElementById('arVideo');
  const arGL    = document.getElementById('arGL');
  const arHud   = document.getElementById('arHud');

  const btnCam  = document.getElementById('arStartCam');
  const btnXR   = document.getElementById('arStartXR');
  const btnStop = document.getElementById('arStopXR');
  const btnReset= document.getElementById('arReset');
  const btnSave = document.getElementById('arSave');
  const btnClear= document.getElementById('arClearHistory');

  const pillAR  = document.getElementById('arPill');
  const pillMode= document.getElementById('arModePill');
  const modeSel = document.getElementById('arModeSel');

  const outMain = document.getElementById('arOutMain');
  const outSub  = document.getElementById('arOutSub');

  const histLbl = document.getElementById('arHistLabel');
  const histList= document.getElementById('arHistList');

  const S = {
    session:null, gl:null, refSpace:null, viewerSpace:null, hitTestSource:null,
    mode:'distance',
    points:[],
    lastHit:null,
    lastText:null,
    history:[],
    running:false
  };

  function setResult(m,s){ outMain.textContent=m; outSub.textContent=s||''; }
  function dist(a,b){
    const dx=a.x-b.x, dy=a.y-b.y, dz=a.z-b.z;
    return Math.sqrt(dx*dx+dy*dy+dz*dz);
  }
  function fmtMeters(m){
    if(!Number.isFinite(m)) return '—';
    if(m>=10) return `${m.toFixed(2)} m`;
    if(m>=1) return `${m.toFixed(3)} m`;
    return `${(m*100).toFixed(1)} cm`;
  }
  function fmtArea(m2){
    if(!Number.isFinite(m2)) return '—';
    return `${m2.toFixed(2)} m²`;
  }
  function updateHistory(){
    histList.innerHTML='';
    S.history.forEach(x=>{const li=document.createElement('li'); li.textContent=x; histList.appendChild(li);});
    histLbl.textContent = `Storico misure (${S.history.length}/10)`;
  }
  function addHistory(x){
    if(S.history.length===10) S.history=[];
    S.history.push(x);
    updateHistory();
  }

  function resizeHud(){
    const dpr = window.devicePixelRatio || 1;
    const rect = arHud.getBoundingClientRect();
    arHud.width = Math.max(1, Math.round(rect.width * dpr));
    arHud.height= Math.max(1, Math.round(rect.height * dpr));
  }
  function resizeGL(){
    const dpr = window.devicePixelRatio || 1;
    const rect = arGL.getBoundingClientRect();
    arGL.width = Math.max(1, Math.round(rect.width * dpr));
    arGL.height= Math.max(1, Math.round(rect.height * dpr));
  }
  window.addEventListener('resize', () => { resizeHud(); resizeGL(); });

  function drawOverlay(){
    const ctx = arHud.getContext('2d');
    ctx.clearRect(0,0,arHud.width,arHud.height);

    const cx = arHud.width/2, cy = arHud.height/2;
    ctx.strokeStyle='rgba(245,245,247,.92)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(cx-18,cy); ctx.lineTo(cx+18,cy);
    ctx.moveTo(cx,cy-18); ctx.lineTo(cx,cy+18);
    ctx.stroke();

    if(S.lastText){
      ctx.font=`${Math.round(14*(window.devicePixelRatio||1))}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace`;
      ctx.lineWidth=6;
      ctx.strokeStyle='rgba(11,15,20,.35)';
      ctx.fillStyle='rgba(245,245,247,.95)';
      ctx.strokeText(S.lastText, cx+22, cy-22);
      ctx.fillText(S.lastText, cx+22, cy-22);
    }

    // laser visivo durante la distanza
    if(S.mode==='distance' && S.points.length>=1){
      ctx.save();
      ctx.setLineDash([18,12]);
      ctx.strokeStyle='rgba(245,245,247,.95)';
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx, cy-220);
      ctx.stroke();
      ctx.restore();
    }
  }

  function resetMeasure(){
    S.points=[];
    S.lastText=null;
    btnSave.disabled=true;
    setResult('—', S.mode==='distance'
      ? 'AR attivo. Tap 1 = A. Muovi: live. Tap 2 = B.'
      : 'Area: 4 tap (rettangolo).'
    );
    drawOverlay();
  }

  async function stopXR(){
    try{ S.hitTestSource?.cancel?.(); }catch{}
    S.hitTestSource=null;

    if(S.session){
      try{ await S.session.end(); }catch{}
    }
    S.session=null;
    S.refSpace=null;
    S.viewerSpace=null;
    S.running=false;

    arGL.style.display='none';
    arVideo.style.display='block';

    btnStop.disabled=true;
    btnReset.disabled=true;
    btnSave.disabled=true;
    setPill(pillAR,'AR: fermo','warn');

    // riattiva camera preview
    try{ await startCamera(arVideo); }catch{}
  }

  // Tap sul layer DOM overlay (funziona dove 'select' non arriva)
  function handleOverlayTap(){
    if(!S.running || !S.lastHit) return;

    if(S.mode==='distance'){
      if(S.points.length===0){
        S.points=[S.lastHit];
        btnSave.disabled=true;
        setResult('Distanza (live)','Punto A impostato. Tap per fissare B.');
      }else if(S.points.length===1){
        S.points=[S.points[0], S.lastHit];
        btnSave.disabled=false;
        setResult('Distanza pronta', S.lastText || '—');
      }else{
        S.points=[S.lastHit];
        btnSave.disabled=true;
        setResult('Distanza (live)','Nuovo A impostato. Tap per fissare B.');
      }
    }else{
      if(S.points.length<4){
        S.points.push(S.lastHit);
        if(S.points.length===4){
          btnSave.disabled=false;
          setResult('Area pronta', S.lastText || '—');
        }else{
          btnSave.disabled=true;
          setResult('Area', `Punti: ${S.points.length}/4`);
        }
      }else{
        S.points=[S.lastHit];
        btnSave.disabled=true;
        setResult('Area','Riparti: punti 1/4');
      }
    }
  }

  // listener tap per overlay (click + touchend)
  document.getElementById('appRoot').addEventListener('click', (e) => {
    // evita che un click sui bottoni piazzi punti
    const t = e.target;
    if(t && (t.closest('button') || t.closest('select') || t.closest('input'))) return;
    handleOverlayTap();
  }, { passive:true });

  document.getElementById('appRoot').addEventListener('touchend', (e) => {
    const t = e.target;
    if(t && (t.closest('button') || t.closest('select') || t.closest('input'))) return;
    handleOverlayTap();
  }, { passive:true });

  async function startXR(){
    const ok = await checkWebXRAR();
    if(!ok){
      setPill(pillAR,'AR: non supportato','warn');
      setResult('AR non disponibile','Questo dispositivo/browser non supporta WebXR AR.');
      return;
    }

    // Avvia preview camera (consigliato) prima
    if(!camStream){
      try{ await startCamera(arVideo); }catch{}
    }

    arVideo.style.display='none';
    arGL.style.display='block';
    resizeGL(); resizeHud();

    const gl =
      arGL.getContext('webgl', { alpha:true, antialias:true, xrCompatible:true }) ||
      arGL.getContext('webgl', { alpha:true, antialias:true });

    if(!gl){
      setPill(pillAR,'AR: WebGL KO','bad');
      setResult('Errore','WebGL non disponibile');
      arGL.style.display='none';
      arVideo.style.display='block';
      return;
    }
    try{ await gl.makeXRCompatible(); }catch{}
    S.gl = gl;

    let session;
    try{
      // DOM OVERLAY = UI e tap visibili in AR
      session = await navigator.xr.requestSession('immersive-ar', {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['local-floor', 'dom-overlay'],
        domOverlay: { root: document.body }
      });
    }catch(e){
      setPill(pillAR,'AR: avvio KO','bad');
      setResult('Errore avvio AR','Permessi o sessione rifiutata.');
      arGL.style.display='none';
      arVideo.style.display='block';
      return;
    }

    S.session = session;
    S.running = true;
    setPill(pillAR,'AR: attivo','ok');
    btnStop.disabled=false;
    btnReset.disabled=false;

    session.addEventListener('end', () => {
      S.running=false;
      setPill(pillAR,'AR: fermo','warn');
      btnStop.disabled=true;
      btnReset.disabled=true;
      btnSave.disabled=true;
      arGL.style.display='none';
      arVideo.style.display='block';
      setResult('—','Sessione AR terminata.');
    });

    const layer = new XRWebGLLayer(session, gl);
    session.updateRenderState({ baseLayer: layer });

    try{
      S.refSpace = await session.requestReferenceSpace('local-floor').catch(async()=>session.requestReferenceSpace('local'));
      S.viewerSpace = await session.requestReferenceSpace('viewer');
      S.hitTestSource = await session.requestHitTestSource({ space: S.viewerSpace });
    }catch(e){
      setPill(pillAR,'AR: hit-test KO','warn');
      setResult('Hit-test KO','AR avviato ma hit-test non disponibile.');
      return;
    }

    // se il device manda "select" funziona uguale
    session.addEventListener('select', handleOverlayTap);

    // Ora che XR è avviato, stop camera preview
    stopCamera();

    resetMeasure();
    session.requestAnimationFrame(onXRFrame);
  }

  function onXRFrame(t, frame){
    if(!S.running || !S.session) return;
    const session = frame.session;
    const gl = S.gl;
    const layer = session.renderState.baseLayer;

    session.requestAnimationFrame(onXRFrame);

    const pose = frame.getViewerPose(S.refSpace);
    if(!pose) return;

    const view = pose.views[0];
    const viewport = layer.getViewport(view);

    gl.bindFramebuffer(gl.FRAMEBUFFER, layer.framebuffer);
    gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
    gl.clearColor(0,0,0,0);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    const hits = frame.getHitTestResults(S.hitTestSource);
    if(hits.length){
      const hitPose = hits[0].getPose(S.refSpace);
      if(hitPose){
        const p = hitPose.transform.position;
        S.lastHit = { x:p.x, y:p.y, z:p.z };
      }
    }

    if(S.mode==='distance' && S.points.length>=1 && S.lastHit){
      const A=S.points[0];
      const B=(S.points.length>=2)?S.points[1]:S.lastHit;
      const m=dist(A,B);
      S.lastText = fmtMeters(m);
      if(S.points.length<2){
        setResult('Distanza (live)', `${S.lastText} • tap per fissare B`);
      }
    }

    if(S.mode==='area'){
      if(S.points.length===4){
        const w=dist(S.points[0],S.points[1]);
        const h=dist(S.points[2],S.points[3]);
        const a=w*h;
        S.lastText = fmtArea(a);
      }else if(S.points.length>=2){
        const w=dist(S.points[0],S.points[1]);
        S.lastText = `Larghezza: ${fmtMeters(w)}`;
      }else{
        S.lastText = null;
      }
    }

    drawOverlay();
  }

  // UI
  btnCam.addEventListener('click', async () => {
    try{
      await startCamera(arVideo);
      setPill(pillAR,'AR: camera OK','ok');
      setResult('—','Camera attiva. Ora premi “Avvia AR”.');
      arVideo.style.display='block';
      arGL.style.display='none';
      resizeHud();
    }catch(err){
      setPill(pillAR,'AR: camera KO','bad');
      setResult('Errore camera', err.message);
    }
  });

  btnXR.addEventListener('click', startXR);
  btnStop.addEventListener('click', stopXR);
  btnReset.addEventListener('click', resetMeasure);

  btnSave.addEventListener('click', () => {
    if(S.mode==='distance' && S.points.length>=2){
      const m=dist(S.points[0],S.points[1]);
      addHistory(`AR Distanza: ${fmtMeters(m)}`);
      btnSave.disabled=true;
      setResult('Salvato ✅', `AR Distanza: ${fmtMeters(m)}`);
    }
    if(S.mode==='area' && S.points.length===4){
      const w=dist(S.points[0],S.points[1]);
      const h=dist(S.points[2],S.points[3]);
      const a=w*h;
      addHistory(`AR Area: ${fmtArea(a)}`);
      btnSave.disabled=true;
      setResult('Salvato ✅', `AR Area: ${fmtArea(a)}`);
    }
  });

  btnClear.addEventListener('click', () => { S.history=[]; updateHistory(); });

  modeSel.addEventListener('change', () => {
    S.mode = modeSel.value;
    pillMode.textContent = `Modalità: ${S.mode==='distance' ? 'Distanza' : 'Area'}`;
    resetMeasure();
  });

  // init
  setPill(pillAR,'AR: —','warn');
  pillMode.textContent = 'Modalità: Distanza';
  updateHistory();
  resizeHud();
})();

show('home');
</script>
</body>
</html>
